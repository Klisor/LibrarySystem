version: '3.8'

networks:
  library-network:
    driver: bridge

volumes:
  mysql-user-data:
  mysql-book-data:
  mysql-borrow-data:
  nacos-data:
  nacos-logs:

services:
  # ==================== Nacos 服务注册中心 ====================
  nacos:
    image: nacos/nacos-server:v2.4.0
    container_name: nacos
    restart: always
    environment:
      - MODE=standalone
      - PREFER_HOST_MODE=hostname
    ports:
      - "8848:8848"
      - "9848:9848"
      - "9849:9849"
    volumes:
      - nacos-logs:/home/nacos/logs
      - nacos-data:/home/nacos/data
    networks:
      - library-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== 基础设施层 ====================

  mysql-user:
    image: mysql:8.0
    container_name: mysql-user
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      MYSQL_DATABASE: user_db
      MYSQL_USER: ${MYSQL_USER:-library_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-library123}
      TZ: Asia/Shanghai
    ports:
      - "3307:3306"
    volumes:
      - mysql-user-data:/var/lib/mysql
    networks:
      - library-network
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-time-zone=+08:00
      - --max_connections=1000

  mysql-book:
    image: mysql:8.0
    container_name: mysql-book
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      MYSQL_DATABASE: book_db
      MYSQL_USER: ${MYSQL_USER:-library_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-library123}
      TZ: Asia/Shanghai
    ports:
      - "3308:3306"
    volumes:
      - mysql-book-data:/var/lib/mysql
    networks:
      - library-network
    command: &mysql-command
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-time-zone=+08:00
      - --max_connections=1000

  mysql-borrow:
    image: mysql:8.0
    container_name: mysql-borrow
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      MYSQL_DATABASE: borrow_db
      MYSQL_USER: ${MYSQL_USER:-library_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-library123}
      TZ: Asia/Shanghai
    ports:
      - "3309:3306"
    volumes:
      - mysql-borrow-data:/var/lib/mysql
    networks:
      - library-network
    command: *mysql-command

  # ==================== 业务服务层 (多实例) ====================

  # 用户服务 - 3个实例，使用不同端口
  user-service-1: &user-service
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    image: library-user-service:latest
    container_name: user-service-1
    restart: unless-stopped
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8083  # 实例1端口
      - SERVER_SERVLET_CONTEXT_PATH=/api
      - NACOS_SERVER_ADDR=nacos:8848
      - INSTANCE_ID=user-1
      - DB_URL=jdbc:mysql://mysql-user:3306/user_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8
      - DB_USERNAME=${MYSQL_USER:-library_user}
      - DB_PASSWORD=${MYSQL_PASSWORD:-library123}
    ports:
      - "8083:8083"  # 实例1暴露端口
    depends_on:
      nacos:
        condition: service_healthy
      mysql-user:
        condition: service_started
    networks:
      - library-network

  user-service-2:
    <<: *user-service
    container_name: user-service-2
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8084  # 实例2端口（不同）
      - SERVER_SERVLET_CONTEXT_PATH=/api
      - NACOS_SERVER_ADDR=nacos:8848
      - DB_URL=jdbc:mysql://mysql-user:3306/user_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8
      - DB_USERNAME=${MYSQL_USER:-library_user}
      - DB_PASSWORD=${MYSQL_PASSWORD:-library123}
      - INSTANCE_ID=user-2
    ports:
      - "8084:8084"  # 实例2暴露端口

  user-service-3:
    <<: *user-service
    container_name: user-service-3
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8085  # 实例3端口（不同）
      - SERVER_SERVLET_CONTEXT_PATH=/api
      - NACOS_SERVER_ADDR=nacos:8848
      - DB_URL=jdbc:mysql://mysql-user:3306/user_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8
      - DB_USERNAME=${MYSQL_USER:-library_user}
      - DB_PASSWORD=${MYSQL_PASSWORD:-library123}
      - INSTANCE_ID=user-3
    ports:
      - "8085:8085"  # 实例3暴露端口

  # 图书服务 - 3个实例，使用不同端口
  book-service-1: &book-service
    build:
      context: ./services/book-service
      dockerfile: Dockerfile
    image: library-book-service:latest
    container_name: book-service-1
    restart: unless-stopped
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8091  # 实例1端口
      - SERVER_SERVLET_CONTEXT_PATH=/api
      - NACOS_SERVER_ADDR=nacos:8848
      - INSTANCE_ID=book-1
      - DB_URL=jdbc:mysql://mysql-book:3306/book_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8
      - DB_USERNAME=${MYSQL_USER:-library_user}
      - DB_PASSWORD=${MYSQL_PASSWORD:-library123}
    ports:
      - "8091:8091"  # 实例1暴露端口
    depends_on:
      nacos:
        condition: service_healthy
      mysql-book:
        condition: service_started
    networks:
      - library-network

  book-service-2:
    <<: *book-service
    container_name: book-service-2
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8092  # 实例2端口（不同）
      - SERVER_SERVLET_CONTEXT_PATH=/api
      - NACOS_SERVER_ADDR=nacos:8848
      - DB_URL=jdbc:mysql://mysql-book:3306/book_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8
      - DB_USERNAME=${MYSQL_USER:-library_user}
      - DB_PASSWORD=${MYSQL_PASSWORD:-library123}
      - INSTANCE_ID=book-2
    ports:
      - "8092:8092"  # 实例2暴露端口

  book-service-3:
    <<: *book-service
    container_name: book-service-3
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8093  # 实例3端口（不同）
      - SERVER_SERVLET_CONTEXT_PATH=/api
      - NACOS_SERVER_ADDR=nacos:8848
      - DB_URL=jdbc:mysql://mysql-book:3306/book_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8
      - DB_USERNAME=${MYSQL_USER:-library_user}
      - DB_PASSWORD=${MYSQL_PASSWORD:-library123}
      - INSTANCE_ID=book-3
    ports:
      - "8093:8093"  # 实例3暴露端口

  # 借阅服务 - 保持1个实例
  borrow-service:
    build:
      context: ./services/borrow-service
      dockerfile: Dockerfile
    image: library-borrow-service:latest
    container_name: borrow-service
    restart: unless-stopped
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8082
      - SERVER_SERVLET_CONTEXT_PATH=/api
      - NACOS_SERVER_ADDR=nacos:8848
      - DB_URL=jdbc:mysql://mysql-borrow:3306/borrow_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8
      - DB_USERNAME=${MYSQL_USER:-library_user}
      - DB_PASSWORD=${MYSQL_PASSWORD:-library123}
      - APP_JWT_SECRET=${JWT_SECRET}
      - APP_JWT_SERVICE_TOKEN=${JWT_SERVICE_TOKEN}
      - APP_BORROW_DEFAULT_DAYS=30
      - APP_BORROW_MAX_COUNT=5
    ports:
      - "8082:8082"
    depends_on:
      nacos:
        condition: service_healthy
      mysql-borrow:
        condition: service_started
    networks:
      - library-network


  # ==================== API网关 ====================
  gateway-service:
    build:
      context: ./services/gateway-service
      dockerfile: Dockerfile
    container_name: gateway-service
    restart: unless-stopped
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - JWT_SECRET=library-management-secret-key-2024
    ports:
      - "8090:8090"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - library-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3