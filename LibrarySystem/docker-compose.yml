version: '3.8'

networks:
  library-network:
    driver: bridge

volumes:
  mysql-user-data:
  mysql-book-data:
  mysql-borrow-data:
  nacos-data:
  nacos-logs:

services:
  # ==================== Nacos 服务注册中心 ====================
  nacos:
    image: nacos/nacos-server:v2.4.0
    container_name: nacos
    restart: always
    environment:
      - MODE=standalone
      - PREFER_HOST_MODE=hostname
    ports:
      - "8848:8848"
      - "9848:9848"
      - "9849:9849"
    volumes:
      - nacos-logs:/home/nacos/logs
      - nacos-data:/home/nacos/data
    networks:
      - library-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== 基础设施层 ====================

  mysql-user:
    image: mysql:8.0
    container_name: mysql-user
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      MYSQL_DATABASE: user_db
      MYSQL_USER: ${MYSQL_USER:-library_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-library123}
      TZ: Asia/Shanghai
    ports:
      - "3307:3306"
    volumes:
      - mysql-user-data:/var/lib/mysql
    networks:
      - library-network
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-time-zone=+08:00
      - --max_connections=1000

  mysql-book:
    image: mysql:8.0
    container_name: mysql-book
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      MYSQL_DATABASE: book_db
      MYSQL_USER: ${MYSQL_USER:-library_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-library123}
      TZ: Asia/Shanghai
    ports:
      - "3308:3306"
    volumes:
      - mysql-book-data:/var/lib/mysql
    networks:
      - library-network
    command: &mysql-command
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-time-zone=+08:00
      - --max_connections=1000

  mysql-borrow:
    image: mysql:8.0
    container_name: mysql-borrow
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      MYSQL_DATABASE: borrow_db
      MYSQL_USER: ${MYSQL_USER:-library_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-library123}
      TZ: Asia/Shanghai
    ports:
      - "3309:3306"
    volumes:
      - mysql-borrow-data:/var/lib/mysql
    networks:
      - library-network
    command: *mysql-command

  # ==================== 业务服务层 ====================
  # 配置原则：通过环境变量 NACOS_SERVER_ADDR 统一传递Nacos地址

  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    image: library-user-service:latest
    container_name: user-service
    restart: unless-stopped
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8083
      - SERVER_SERVLET_CONTEXT_PATH=/api
      # 统一使用此变量告知服务Nacos地址
      - NACOS_SERVER_ADDR=nacos:8848
      # 数据库连接信息
      - DB_URL=jdbc:mysql://mysql-user:3306/user_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8
      - DB_USERNAME=${MYSQL_USER:-library_user}
      - DB_PASSWORD=${MYSQL_PASSWORD:-library123}
      # JWT配置
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=86400
    ports:
      - "8083:8083"
    depends_on:
      nacos:
        condition: service_healthy
      mysql-user:
        condition: service_started
    networks:
      - library-network

  book-service:
    build:
      context: ./services/book-service
      dockerfile: Dockerfile
    image: library-book-service:latest
    container_name: book-service
    restart: unless-stopped
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8081
      - SERVER_SERVLET_CONTEXT_PATH=/api
      # Nacos地址
      - NACOS_SERVER_ADDR=nacos:8848
      # 数据库连接信息
      - DB_URL=jdbc:mysql://mysql-book:3306/book_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8
      - DB_USERNAME=${MYSQL_USER:-library_user}
      - DB_PASSWORD=${MYSQL_PASSWORD:-library123}
      # JWT配置
      - JWT_SECRET=${JWT_SECRET}
    ports:
      - "8081:8081"
    depends_on:
      nacos:
        condition: service_healthy
      mysql-book:
        condition: service_started
    networks:
      - library-network

  borrow-service:
    build:
      context: ./services/borrow-service
      dockerfile: Dockerfile
    image: library-borrow-service:latest
    container_name: borrow-service
    restart: unless-stopped
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8082
      - SERVER_SERVLET_CONTEXT_PATH=/api
      # Nacos地址
      - NACOS_SERVER_ADDR=nacos:8848
      # 数据库连接信息
      - DB_URL=jdbc:mysql://mysql-borrow:3306/borrow_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8
      - DB_USERNAME=${MYSQL_USER:-library_user}
      - DB_PASSWORD=${MYSQL_PASSWORD:-library123}
      # 应用配置 (注意：服务间调用应改为服务名，而非具体URL)
      - APP_JWT_SECRET=${JWT_SECRET}
      - APP_JWT_SERVICE_TOKEN=${JWT_SERVICE_TOKEN}
      # 借阅规则
      - APP_BORROW_DEFAULT_DAYS=30
      - APP_BORROW_MAX_COUNT=5
    ports:
      - "8082:8082"
    depends_on:
      nacos:
        condition: service_healthy
      mysql-borrow:
        condition: service_started
      user-service:
        condition: service_started
      book-service:
        condition: service_started
    networks:
      - library-network